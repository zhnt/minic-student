CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -g
SRCDIR = .
SOURCES = ast.c bytecode.c compiler.c debug.c lexer.c parser.c vm.c
HEADERS = ast.h bytecode.h compiler.h debug.h lexer.h parser.h vm.h
OBJECTS = $(SOURCES:.c=.o)
TARGET = minic

.PHONY: all clean test debug help

all: $(TARGET)

$(TARGET): minic.c $(OBJECTS)
	$(CC) $(CFLAGS) -o $(TARGET) minic.c $(OBJECTS) -lm

%.o: %.c $(HEADERS)
	$(CC) $(CFLAGS) -c $< -o $@

# è°ƒè¯•ç‰ˆæœ¬ï¼ˆå¸¦è°ƒè¯•ä¿¡æ¯ï¼‰
debug: CFLAGS += -DDEBUG -O0
debug: $(TARGET)

# æµ‹è¯•ç›®æ ‡
test: $(TARGET)
	@echo "=== æµ‹è¯•åŸºç¡€åŠŸèƒ½ ==="
	@echo "5+3*2 =" `echo "5+3*2" | ./$(TARGET) | tail -1`
	@echo "-5+3 =" `echo "-5+3" | ./$(TARGET) | tail -1`
	@echo "1+2;3*4;5-1 =" `echo "1+2;3*4;5-1" | ./$(TARGET) | tail -1`
	@echo
	@echo "=== æµ‹è¯•å˜é‡åŠŸèƒ½ï¼ˆå®žçŽ°åŽï¼‰ ==="
	@echo "x=5 =" `echo "x=5" | ./$(TARGET) | tail -1`
	@echo "x+3 =" `echo "x=5;x+3" | ./$(TARGET) | tail -1`

# æ¸…ç†
clean:
	@echo "æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	rm -f $(OBJECTS) $(TARGET)

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "ç¼–è¯‘å™¨å˜é‡ç³»ç»Ÿå®žçŽ°ä½œä¸š"
	@echo "======================="
	@echo "å¯ç”¨ç›®æ ‡ï¼š"
	@echo "  make       - ç¼–è¯‘ç¨‹åº"
	@echo "  make test  - è¿è¡Œæµ‹è¯•"
	@echo "  make debug - ç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬"
	@echo "  make clean - æ¸…ç†æ–‡ä»¶"
	@echo "  make help  - æ˜¾ç¤ºæ­¤å¸®åŠ©"
	@echo ""
	@echo "æµ‹è¯•å‘½ä»¤ï¼š"
	@echo "  ./minic                  # äº¤äº’æ¨¡å¼"
	@echo "  echo '5+3' | ./minic     # æ‰¹å¤„ç†æ¨¡å¼"
	@echo "  ./minic --help           # æŸ¥çœ‹æ‰€æœ‰é€‰é¡¹"

# å­¦ç”Ÿä¸“ç”¨ç›®æ ‡
student-test: $(TARGET)
	@echo "ðŸŽ¯ å­¦ç”Ÿä½œä¸šæµ‹è¯•å¼€å§‹..."
	@echo "åŸºç¡€è®¡ç®—æµ‹è¯•ï¼š"
	@echo "3+4*5 =" `echo "3+4*5" | ./$(TARGET) | tail -1`
	@echo "-3+5 =" `echo "-3+5" | ./$(TARGET) | tail -1`
	@echo "(1+2)*3 =" `echo "(1+2)*3" | ./$(TARGET) | tail -1`
	@echo ""
	@echo "å˜é‡åŠŸèƒ½æµ‹è¯•ï¼ˆå®žçŽ°åŽï¼‰ï¼š"
	@echo "x=10 =" `echo "x=10" | ./$(TARGET) | tail -1`
	@echo "x*2 =" `echo "x=10;x*2" | ./$(TARGET) | tail -1`
	@echo ""
	@echo "âœ… å¦‚ä¸Šè¿°æµ‹è¯•é€šè¿‡ï¼Œå˜é‡ç³»ç»Ÿå®žçŽ°æˆåŠŸï¼"