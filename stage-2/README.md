# ğŸ¯ Minicé˜¶æ®µ2ï¼šè¿ç®—ç¬¦ä¼˜å…ˆçº§ä¸å››åˆ™è¿ç®—

## ğŸ‰ å®éªŒç›®æ ‡ï¼šé€šè¿‡å¯¹æ¯”å­¦ä¹ æŒæ¡ä¼˜å…ˆçº§

æœ¬é˜¶æ®µé‡‡ç”¨**å¯¹æ¯”å¼å­¦ä¹ **æ–¹æ³•ï¼Œè®©å­¦ç”Ÿé€šè¿‡è€ç‰ˆæœ¬å’Œæ–°ç‰ˆæœ¬çš„å¯¹æ¯”ï¼Œæ·±å…¥ç†è§£è¿ç®—ç¬¦ä¼˜å…ˆçº§çš„é‡è¦æ€§ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
stage-2/
â”œâ”€â”€ src/           # è€ç‰ˆæœ¬ï¼šæ‰å¹³è§£æå™¨ï¼ˆåªæœ‰+-ï¼‰
â”œâ”€â”€ newsrc/        # æ–°ç‰ˆæœ¬ï¼šåˆ†å±‚è§£æå™¨ï¼ˆé¢„ç½®æ¶æ„ï¼Œç¼ºå°‘*/()ï¼‰
â”œâ”€â”€ minic          # è€ç‰ˆæœ¬å¯æ‰§è¡Œæ–‡ä»¶
â”œâ”€â”€ minic-new      # æ–°ç‰ˆæœ¬å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå­¦ç”Ÿæ„å»ºï¼‰
â””â”€â”€ Grammar-Guide.md # åˆ†å±‚è¯­æ³•è¯¦è§£
```

## ğŸ” å®éªŒæµç¨‹ï¼š5æ­¥æŒæ¡ä¼˜å…ˆçº§

### ç¬¬ä¸€æ­¥ï¼šåœ¨è€ç‰ˆæœ¬ä¸­æ·»åŠ *æ³•ï¼ˆä½“éªŒé—®é¢˜ï¼‰
åœ¨è€ç‰ˆæœ¬ï¼ˆsrc/ï¼‰ä¸­ç›´æ¥æ·»åŠ ä¹˜æ³•ï¼Œ**ä¸**ä¿®æ”¹ä¼˜å…ˆçº§ï¼š

```bash
cd stage-2
make                # æ„å»ºè€ç‰ˆæœ¬
./minic             # æµ‹è¯•ï¼š2 + 3 * 4
# ç»“æœï¼š20 âŒ  ï¼ˆå‘ç°é—®é¢˜ï¼ï¼‰
```

**é¢„æœŸç»“æœ**ï¼šå­¦ç”Ÿä¼šå‘ç°åœ¨æ‰å¹³è§£æå™¨ä¸­æ·»åŠ ä¹˜æ³•ä¼šå¯¼è‡´`2 + 3 * 4 = 20`çš„é”™è¯¯ç»“æœã€‚

### ç¬¬äºŒæ­¥ï¼šå‘ç°é—®é¢˜ï¼Œå¯¹æ¯”åˆ†æ
å­¦ç”Ÿä¼šå‘ç°ï¼š
- è€ç‰ˆæœ¬ï¼šæ‰€æœ‰è¿ç®—ç¬¦åŒç­‰ä¼˜å…ˆçº§ï¼Œä»å·¦åˆ°å³
- éœ€è¦ï¼šæ•°å­¦æ­£ç¡®çš„ä¼˜å…ˆçº§ï¼ˆå…ˆä¹˜é™¤ååŠ å‡ï¼‰
- éœ€è¦ï¼šæ‹¬å·æ”¯æŒæ”¹å˜è¿ç®—é¡ºåº

### ç¬¬ä¸‰æ­¥ï¼šå­¦ä¹ åˆ†å±‚è¯­æ³•æ¶æ„
é˜…è¯» `Grammar-Guide.md`ï¼Œç†è§£ï¼š
- **exprå±‚**ï¼šå¤„ç†åŠ å‡æ³•ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰
- **termå±‚**ï¼šå¤„ç†ä¹˜é™¤æ³•ï¼ˆä¸­ç­‰ä¼˜å…ˆçº§ï¼‰
- **factorå±‚**ï¼šå¤„ç†åŸºæœ¬å…ƒç´ å’Œæ‹¬å·ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

### ç¬¬å››æ­¥ï¼šåœ¨æ–°æ¶æ„ä¸­æ·»åŠ åŠŸèƒ½
ä½¿ç”¨newsrcä¸­çš„é¢„ç½®åˆ†å±‚æ¶æ„ï¼Œå­¦ç”Ÿéœ€è¦ï¼š

#### ä»»åŠ¡1ï¼šåœ¨termå±‚æ·»åŠ ä¹˜é™¤æ³•
åœ¨ `newsrc/parser.c` çš„ `parse_term()` å‡½æ•°ä¸­æ·»åŠ ï¼š
```c
// TODO: å­¦ç”Ÿéœ€è¦åœ¨è¿™é‡Œæ·»åŠ ä¹˜æ³•å’Œé™¤æ³•æ”¯æŒ
while (parser->current.type == TOKEN_STAR || parser->current.type == TOKEN_SLASH) {
    // æ·»åŠ å¤„ç†é€»è¾‘
}
```

#### ä»»åŠ¡2ï¼šåœ¨factorå±‚æ·»åŠ æ‹¬å·
åœ¨ `newsrc/parser.c` çš„ `parse_factor()` å‡½æ•°ä¸­æ·»åŠ ï¼š
```c
// TODO: å­¦ç”Ÿéœ€è¦åœ¨è¿™é‡Œæ·»åŠ æ‹¬å·æ”¯æŒ
} else if (parser->current.type == TOKEN_LEFT_PAREN) {
    // æ·»åŠ æ‹¬å·å¤„ç†
}
```

#### æ„å»ºæ–°ç‰ˆæœ¬ï¼š
```bash
make new            # æ„å»ºæ–°ç‰ˆæœ¬
./minic-new         # æµ‹è¯•ï¼š2 + 3 * 4 = 14 âœ…
```

### ç¬¬äº”æ­¥ï¼šå¯¹æ¯”åˆ†æï¼Œæ·±å…¥ç†è§£
å¯¹æ¯”ä¸¤ç§å®ç°ï¼š

| ç‰¹æ€§ | è€ç‰ˆæœ¬ï¼ˆsrc/ï¼‰ | æ–°ç‰ˆæœ¬ï¼ˆnewsrc/ï¼‰ |
|------|---------------|------------------|
| æ¶æ„ | æ‰å¹³è§£æå™¨ | åˆ†å±‚è§£æå™¨ |
| ä¼˜å…ˆçº§ | æ—  | æ•°å­¦æ­£ç¡® |
| å¯æ‰©å±•æ€§ | å·® | å¥½ |
| ä»£ç ç»“æ„ | ç®€å• | æ¸…æ™° |

## ğŸ¯ å…·ä½“å®æ–½æ­¥éª¤

### ğŸ”§ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

#### è€ç‰ˆæœ¬ï¼ˆsrc/ï¼‰- ä»…ç¬¬ä¸€æ­¥ä½¿ç”¨
1. `lexer.h/c` - æ·»åŠ  `TOKEN_STAR`, `TOKEN_SLASH`
2. `parser.c` - ç›´æ¥æ·»åŠ ä¹˜é™¤æ³•ï¼ˆä½“éªŒé—®é¢˜ï¼‰
3. `bytecode.h` - æ·»åŠ  `OP_MUL`, `OP_DIV`
4. `compiler.c` - ç”Ÿæˆä¹˜é™¤æ³•ä»£ç 
5. `vm.c` - å®ç°ä¹˜é™¤æ³•è¿ç®—
6. `debug.c` - æ·»åŠ è°ƒè¯•æ”¯æŒ

#### æ–°ç‰ˆæœ¬ï¼ˆnewsrc/ï¼‰- ä¸»è¦å·¥ä½œ
1. `lexer.h/c` - æ·»åŠ  `* / ( )` æ ‡è®°
2. `parser.c` - åœ¨TODOä½ç½®æ·»åŠ ä¹˜é™¤æ³•å’Œæ‹¬å·æ”¯æŒ
3. `bytecode.h` - æ·»åŠ  `OP_MUL`, `OP_DIV`
4. `compiler.c` - ç”Ÿæˆä¹˜é™¤æ³•ä»£ç 
5. `vm.c` - å®ç°ä¹˜é™¤æ³•è¿ç®—
6. `debug.c` - æ·»åŠ è°ƒè¯•æ”¯æŒ

## ğŸ§ª æµ‹è¯•éªŒè¯

### è€ç‰ˆæœ¬æµ‹è¯•ï¼ˆä½“éªŒé—®é¢˜ï¼‰
```bash
echo "2 + 3 * 4" | ./minic     # åº”è¯¥å¾—åˆ°20 âŒ
echo "10 - 6 / 2" | ./minic    # åº”è¯¥å¾—åˆ°2 âŒ
```

### æ–°ç‰ˆæœ¬æµ‹è¯•ï¼ˆéªŒè¯æ­£ç¡®æ€§ï¼‰
```bash
# æ„å»ºæ–°ç‰ˆæœ¬
make new

# ä¼˜å…ˆçº§æµ‹è¯•
echo "2 + 3 * 4" | ./minic-new     # åº”è¯¥å¾—åˆ°14 âœ…
echo "10 - 6 / 2" | ./minic-new    # åº”è¯¥å¾—åˆ°7 âœ…

# æ‹¬å·æµ‹è¯•
echo "(2 + 3) * 4" | ./minic-new   # åº”è¯¥å¾—åˆ°20 âœ…
echo "8 / (2 + 2)" | ./minic-new   # åº”è¯¥å¾—åˆ°2 âœ…

# æ··åˆæµ‹è¯•
echo "1 + 2 * 3 - 4 / 2" | ./minic-new  # åº”è¯¥å¾—åˆ°5 âœ…
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ğŸ“‹ å®éªŒæ£€æŸ¥æ¸…å•

#### æ­¥éª¤1ï¼šåœ¨è€ç‰ˆæœ¬ä¸­ä½“éªŒé—®é¢˜
```bash
# 1. æ„å»ºè€ç‰ˆæœ¬
make clean && make

# 2. ä½“éªŒå½“å‰é—®é¢˜
echo "2 + 3 * 4" | ./minic
# å¾—åˆ°20ï¼Œæ„è¯†åˆ°éœ€è¦ä¼˜å…ˆçº§ï¼
```

#### æ­¥éª¤2ï¼šå­¦ä¹ åˆ†å±‚æ¶æ„
```bash
# é˜…è¯»åˆ†å±‚è¯­æ³•æŒ‡å—
cat Grammar-Guide.md
```

#### æ­¥éª¤3ï¼šåœ¨æ–°æ¶æ„ä¸­å®ç°åŠŸèƒ½
```bash
# 1. ç¼–è¾‘newsrc/parser.cï¼Œå®ŒæˆTODOéƒ¨åˆ†
# 2. æ·»åŠ lexeræ”¯æŒ
# 3. æ„å»ºæ–°ç‰ˆæœ¬
make new

# 4. éªŒè¯æ­£ç¡®æ€§
echo "2 + 3 * 4" | ./minic-new    # åº”è¯¥å¾—åˆ°14 âœ…
echo "(2 + 3) * 4" | ./minic-new  # åº”è¯¥å¾—åˆ°20 âœ…
```

#### æ­¥éª¤4ï¼šå¯¹æ¯”ä¸¤ç§å®ç°
```bash
# å¯¹æ¯”ç»“æœ
./minic "2 + 3 * 4"         # è€ç‰ˆæœ¬ï¼š20 âŒ
./minic-new "2 + 3 * 4"     # æ–°ç‰ˆæœ¬ï¼š14 âœ…
```

#### æ­¥éª¤5ï¼šæ·±å…¥ç†è§£
- å¯¹æ¯”ä¸¤ç§parser.cçš„å®ç°
- æ€è€ƒä¸ºä»€ä¹ˆåˆ†å±‚æ¶æ„æ›´å¥½
- ç†è§£å¦‚ä½•æ‰©å±•åˆ°æ›´å¤šè¿ç®—ç¬¦

---

**ğŸ“ å®Œæˆå®éªŒåï¼Œä½ å°†çœŸæ­£ç†è§£ï¼šä¸ºä»€ä¹ˆéœ€è¦åˆ†å±‚è§£æå™¨ï¼Œä»¥åŠå¦‚ä½•ä¼˜é›…åœ°å¤„ç†è¿ç®—ç¬¦ä¼˜å…ˆçº§ï¼**

### ğŸ¯ æ‰©å±•ä»»åŠ¡ï¼šä¹˜é™¤æ³•ä¸æ‹¬å·æ”¯æŒ

#### ğŸ“‹ ä½œä¸šè¦æ±‚
åœ¨ä¼˜å…ˆçº§åŸºç¡€ä¸Šï¼Œæ·»åŠ å®Œæ•´çš„ä¹˜é™¤æ³•å’Œæ‹¬å·æ”¯æŒï¼š

#### 1. å®ç°ä¹˜æ³•è¿ç®— `*`
- **ç¤ºä¾‹**ï¼š`5 * 3` â†’ `15.00`
- **ä¼˜å…ˆçº§æµ‹è¯•**ï¼š`2 + 3 * 4` â†’ `14.00`

#### 2. å®ç°é™¤æ³•è¿ç®— `/`
- **ç¤ºä¾‹**ï¼š`10 / 2` â†’ `5.00`
- **ä¼˜å…ˆçº§æµ‹è¯•**ï¼š`10 - 6 / 2` â†’ `7.00`

#### 3. å®ç°æ‹¬å·æ”¯æŒ `()`
- **ç¤ºä¾‹**ï¼š`(2 + 3) * 4` â†’ `20.00`
- **ä¼˜å…ˆçº§æµ‹è¯•**ï¼š`(10 - 6) / 2` â†’ `2.00`
- **åµŒå¥—æµ‹è¯•**ï¼š`((1 + 2) * 3) - 4` â†’ `5.00`

#### 4. å®Œæˆè°ƒè¯•æ”¯æŒ
- æ‰€æœ‰è°ƒè¯•é€‰é¡¹æ”¯æŒæ–°è¿ç®—ç¬¦å’Œæ‹¬å·

#### ğŸ“ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ7ä¸ªï¼‰
1. `lexer.h` - æ·»åŠ  `TOKEN_STAR`, `TOKEN_SLASH`, `TOKEN_LEFT_PAREN`, `TOKEN_RIGHT_PAREN`
2. `lexer.c` - è¯†åˆ« `* / ( )` å­—ç¬¦
3. `parser.c` - å®ç°åˆ†å±‚è§£æå™¨ + ä¹˜é™¤æ³•è¡¨è¾¾å¼ + æ‹¬å·æ”¯æŒ
4. `bytecode.h` - æ·»åŠ  `OP_MUL` å’Œ `OP_DIV` æŒ‡ä»¤
5. `compiler.c` - ç”Ÿæˆä¹˜æ³•å’Œé™¤æ³•ä»£ç 
6. `vm.c` - æ‰§è¡Œä¹˜æ³•å’Œé™¤æ³•è¿ç®—
7. `debug.c` - æ·»åŠ MULå’ŒDIVè°ƒè¯•æ”¯æŒ

#### ğŸ¯ æµ‹è¯•ç”¨ä¾‹
å®Œæˆä½œä¸šåï¼Œç¡®ä¿ä»¥ä¸‹æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼š

#### ä¼˜å…ˆçº§æµ‹è¯•
```bash
# ä¼˜å…ˆçº§éªŒè¯
echo "2 + 3 * 4" | ./minic     # 14.00 (ä¸æ˜¯20)
echo "10 - 6 / 2" | ./minic    # 7.00  (ä¸æ˜¯2)
echo "8 / 2 + 3 * 2" | ./minic  # 10.00 (4+6)
echo "1 + 2 * 3 - 4 / 2" | ./minic  # 5.00
```

#### ä¹˜é™¤æ³•æµ‹è¯•
```bash
# ä¹˜æ³•æµ‹è¯•
echo "5 * 3" | ./minic          # 15.00
echo "2 * 3 * 4" | ./minic      # 24.00

# é™¤æ³•æµ‹è¯•  
echo "10 / 2" | ./minic         # 5.00
echo "20 / 4 / 5" | ./minic     # 1.00
```

#### æ‹¬å·æµ‹è¯•
```bash
# æ‹¬å·ä¼˜å…ˆçº§éªŒè¯
echo "(2 + 3) * 4" | ./minic     # 20.00 (æ‹¬å·ä¼˜å…ˆ)
echo "(10 - 6) / 2" | ./minic    # 2.00  (æ‹¬å·ä¼˜å…ˆ)
echo "8 / (2 + 2)" | ./minic     # 2.00  (æ‹¬å·ä¼˜å…ˆ)
echo "((1 + 2) * 3) - 4" | ./minic  # 5.00 (åµŒå¥—æ‹¬å·)
```

#### æ··åˆè¿ç®—
```bash
echo "10 + 5 * 2" | ./minic     # 20.00
echo "100 - 50 / 5" | ./minic   # 90.00
echo "(10 + 5) * 2" | ./minic  # 30.00 (æ‹¬å·æ”¹å˜ä¼˜å…ˆçº§)
```

#### è°ƒè¯•æµ‹è¯•
```bash
# æ£€æŸ¥ä¼˜å…ˆçº§å®ç°
./minic -vt -va -vb -ve  # è¾“å…¥ï¼š2 + 3 * 4
```

### ğŸ† è¿›é˜¶æŒ‘æˆ˜ï¼ˆé€‰åšï¼‰
1. **é™¤é›¶é”™è¯¯**ï¼šä¼˜é›…å¤„ç†é™¤é›¶é”™è¯¯
2. **å–æ¨¡è¿ç®—**ï¼šæ·»åŠ  `%` è¿ç®—ç¬¦
3. **ä¸€å…ƒè¿ç®—**ï¼šæ”¯æŒ `-5` è¿™æ ·çš„è´Ÿæ•°

### ğŸš€ å¼€å§‹ä½œä¸š

#### ç¬¬ä¸€æ­¥ï¼šç†è§£å½“å‰é—®é¢˜
```bash
make clean && make
echo "2 + 3 * 4" | ./minic  # ç°åœ¨å¾—åˆ°20ï¼Œé”™è¯¯ï¼éœ€è¦14
```

#### ç¬¬äºŒæ­¥ï¼šé‡æ„è¿ç®—ç¬¦ä¼˜å…ˆçº§ï¼ˆæ ¸å¿ƒï¼‰
**å…³é”®ï¼šå…ˆé‡æ„parseræ¶æ„ï¼Œå†æ·»åŠ æ–°è¿ç®—ç¬¦**

1. **å…ˆé‡æ„parser** - å»ºç«‹exprâ†’termâ†’factorä¸‰å±‚æ¶æ„
   - è¿™ä¸€æ­¥åªå¤„ç†åŠ å‡æ³•ï¼ŒéªŒè¯æ¶æ„æ­£ç¡®æ€§
   - æµ‹è¯•ï¼š`2 + 3 - 4` åº”è¯¥æ­£å¸¸å·¥ä½œ

2. **å†æ·»åŠ ä¹˜é™¤æ³•** - åœ¨termå±‚æ·»åŠ  `*` `/` æ”¯æŒ
   - æµ‹è¯•ï¼š`2 + 3 * 4` åº”è¯¥å¾—åˆ°14

3. **æœ€åæ·»åŠ æ‹¬å·** - åœ¨factorå±‚æ·»åŠ  `()` æ”¯æŒ
   - æµ‹è¯•ï¼š`(2 + 3) * 4` åº”è¯¥å¾—åˆ°20

#### ç¬¬ä¸‰æ­¥ï¼šæ¸è¿›å¼éªŒè¯
æ¯å®Œæˆä¸€ä¸ªå°æ­¥éª¤ï¼Œç«‹å³æµ‹è¯•éªŒè¯ï¼š

```bash
# æ­¥éª¤1ï¼šéªŒè¯ä¼˜å…ˆçº§æ¶æ„
echo "2 + 3 - 4" | ./minic  # åº”è¯¥å¾—åˆ°1

# æ­¥éª¤2ï¼šéªŒè¯ä¹˜é™¤æ³•
echo "2 + 3 * 4" | ./minic  # åº”è¯¥å¾—åˆ°14

# æ­¥éª¤3ï¼šéªŒè¯æ‹¬å·
echo "(2 + 3) * 4" | ./minic  # åº”è¯¥å¾—åˆ°20
```

#### ğŸ’¡ å®ç°æç¤º
- **åˆ†å±‚æ€è€ƒ**ï¼šè¡¨è¾¾å¼ â†’ é¡¹ â†’ å› å­
- **ä¼˜å…ˆçº§**ï¼šä¹˜é™¤æ³•å±‚é«˜äºåŠ å‡æ³•å±‚
- **æµ‹è¯•é©±åŠ¨**ï¼šæ¯æ­¥ä¿®æ”¹åç«‹å³æµ‹è¯•
- **è°ƒè¯•å·¥å…·**ï¼šä½¿ç”¨-vt/-vaè§‚å¯ŸASTç»“æ„

### ğŸ¯ å®é™…æ¶æ„å±•ç¤º

newsrc/parser.cä¸­å·²ç»é¢„ç½®äº†åˆ†å±‚æ¶æ„ï¼Œå­¦ç”Ÿåªéœ€è¦å®ŒæˆTODOéƒ¨åˆ†ï¼š

#### å½“å‰æ¶æ„ï¼ˆå·²é¢„ç½®ï¼‰
```c
// âœ… exprå±‚ï¼šå¤„ç†åŠ å‡æ³•ï¼ˆå·²å®Œæ•´ï¼‰
static ASTNode* parse_expression(Parser* parser) {
    ASTNode* left = parse_term(parser);
    while (parser->current.type == TOKEN_PLUS || parser->current.type == TOKEN_MINUS) {
        TokenType op = parser->current.type;
        parser_consume(parser, op);
        ASTNode* right = parse_term(parser);
        char op_char = (op == TOKEN_PLUS) ? '+' : '-';
        left = ast_binary_op(op_char, left, right);
    }
    return left;
}

// ğŸ“ termå±‚ï¼šå¤„ç†ä¹˜é™¤æ³•ï¼ˆå­¦ç”Ÿéœ€è¦æ·»åŠ *å’Œ/ï¼‰
static ASTNode* parse_term(Parser* parser) {
    ASTNode* left = parse_factor(parser);
    
    // TODO: å­¦ç”Ÿéœ€è¦åœ¨è¿™é‡Œæ·»åŠ ä¹˜æ³•å’Œé™¤æ³•æ”¯æŒ
    // æ·»åŠ  while å¾ªç¯å¤„ç† TOKEN_STAR å’Œ TOKEN_SLASH
    return left;
}

// âœ… factorå±‚ï¼šå¤„ç†åŸºæœ¬å…ƒç´ å’Œæ‹¬å·ï¼ˆå·²å®Œæ•´ï¼‰
static ASTNode* parse_factor(Parser* parser) {
    if (parser->current.type == TOKEN_NUMBER) {
        return ast_number(...);
    } else if (parser->current.type == TOKEN_IDENTIFIER) {
        return ast_identifier(...);
    } else if (parser->current.type == TOKEN_LEFT_PAREN) {
        // æ‹¬å·æ”¯æŒå·²å®Œæ•´å®ç°
        parser_consume(parser, TOKEN_LEFT_PAREN);
        ASTNode* expr = parse_expression(parser);
        parser_consume(parser, TOKEN_RIGHT_PAREN);
        return expr;
    }
    return ...;
}
```

---

**ğŸ‰ å®Œæˆåï¼Œä½ å°†æ‹¥æœ‰ä¸€ä¸ªæ”¯æŒ + - * / å››åˆ™è¿ç®—ä¸”å…·å¤‡æ­£ç¡®ä¼˜å…ˆçº§çš„å®Œæ•´ç¼–è¯‘å™¨ï¼**

**ğŸš€ ä¸‹ä¸€æ­¥é¢„å‘Š**ï¼šé˜¶æ®µ3å°†å­¦ä¹ æ‹¬å·æ”¯æŒå’Œæ›´å¤æ‚çš„è¡¨è¾¾å¼å¤„ç†ã€‚